/*
	Leaflet.print, implements the Mapfish print protocol allowing a Leaflet map to be printed using either the Mapfish or GeoServer print module.
	(c) 2013, Adam Ratcliffe, GeoSmart Maps Limited
*/
!function(t,i){L.print=L.print||{},L.print.Provider=L.Class.extend({includes:L.Mixin.Events,statics:{MAX_RESOLUTION:156543.03390625,MAX_EXTENT:[-20037508.34,-20037508.34,20037508.34,20037508.34],SRS:"EPSG:3857",INCHES_PER_METER:39.3701,DPI:72,UNITS:"m"},options:{autoLoad:!1,autoOpen:!0,outputFormat:"pdf",outputFilename:"leaflet-map",method:"POST",rotation:0,customParams:{}},initialize:function(t){if(L.version<="0.5.1")throw"Leaflet.print requires Leaflet 0.6.0+. Download latest from https://github.com/Leaflet/Leaflet/";var i;t=L.setOptions(this,t),t.map&&this.setMap(t.map),t.capabilities?this._capabilities=t.capabilities:this.options.autoLoad&&this.loadCapabilities(),t.listeners&&(t.listeners.context&&(i=t.listeners.context,delete t.listeners.context),this.addEventListener(t.listeners,i))},loadCapabilities:function(){if(this.options.url){var t;t=this.options.url+"/info.json",this.options.proxy&&(t=this.options.proxy+t),$.ajax({type:"GET",dataType:"json",url:t,success:L.Util.bind(this.onCapabilitiesLoad,this)})}},print:function(i){if(i=L.extend(L.extend({},this.options),i),!i.layout||!i.dpi)throw"Must provide a layout name and dpi value to print";this.fire("beforeprint",{provider:this,map:this._map});var o,e=JSON.stringify(L.extend({units:L.print.Provider.UNITS,srs:L.print.Provider.SRS,layout:i.layout,dpi:i.dpi,outputFormat:i.outputFormat,outputFilename:i.outputFilename,layers:this._encodeLayers(this._map),pages:[{center:this._projectCoords(L.print.Provider.SRS,this._map.getCenter()),scale:this._getScale(),rotation:i.rotation}]},this.options.customParams));"GET"===i.method?(o=this._capabilities.printURL+"?spec="+encodeURIComponent(e),i.proxy&&(o=i.proxy+encodeURIComponent(o)),t.open(o),this.fire("print",{provider:this,map:this._map})):(o=this._capabilities.createURL,i.proxy&&(o=i.proxy+o),this._xhr&&this._xhr.abort(),this._xhr=$.ajax({type:"POST",contentType:"application/json; charset=UTF-8",processData:!1,dataType:"json",url:o,data:e,success:L.Util.bind(this.onPrintSuccess,this),error:L.Util.bind(this.onPrintError,this)}))},getCapabilities:function(){return this._capabilities},setMap:function(t){this._map=t},setDpi:function(t){var i=this.options.dpi;i!==t&&(this.options.dpi=t,this.fire("dpichange",{provider:this,dpi:t}))},setLayout:function(t){var i=this.options.layout;i!==t&&(this.options.layout=t,this.fire("layoutchange",{provider:this,layout:t}))},setRotation:function(t){var i=this.options.rotation;i!==this.options.rotation&&(this.options.rotation=t,this.fire("rotationchange",{provider:this,rotation:t}))},_getLayers:function(t){var i,o,e,n=[],s=[],r=[],a=[];for(e in t._layers)if(t._layers.hasOwnProperty(e)){if(!t._layers.hasOwnProperty(e))continue;var l=t._layers[e];l instanceof L.TileLayer.WMS||l instanceof L.TileLayer?r.push(l):l instanceof L.ImageOverlay?a.push(l):l instanceof L.Marker?n.push(l):l instanceof L.Path&&l.toGeoJSON&&s.push(l)}return n.sort(function(t,i){return t._icon.style.zIndex-i._icon.style.zIndex}),r.sort(function(t,i){return t._container.style.zIndex-i._container.style.zIndex}),i=[].slice.call(this,t._panes.overlayPane.childNodes),a.sort(function(t,o){return $.inArray(t._image,i)-$.inArray(o._image,i)}),t._pathRoot&&(o=[].slice.call(this,t._pathRoot.childNodes),s.sort(function(t,i){return $.inArray(t._container,o)-$.inArray(i._container,o)})),r.concat(s).concat(a).concat(n)},_getScale:function(){for(var t,i,o=this._map,e=o.getBounds(),n=1e3*L.print.Provider.INCHES_PER_METER,s=this._capabilities.scales,r=e.getSouthWest(),a=e.getNorthEast(),l=(r.lat+a.lat)/2,c=L.latLng(l,r.lng),p=L.latLng(l,a.lng),h=c.distanceTo(p),u=o.getSize().x,d=h/u/1e3,f=(d||1e-6)*n*L.print.Provider.DPI,_=Number.POSITIVE_INFINITY,y=s.length;y--;)t=Math.abs(f-s[y].value),_>t&&(_=t,i=parseInt(s[y].value,10));return i},_getLayoutByName:function(t){var i,o,e;for(o=0,e=this._capabilities.layouts.length;e>o;o++)if(this._capabilities.layouts[o].name===t){i=this._capabilities.layouts[o];break}return i},_encodeLayers:function(t){var i,o,e=[],n=[],s=this._getLayers(t);for(o=0;o<s.length;o++)i=s[o],i instanceof L.TileLayer.WMS?e.push(this._encoders.layers.tilelayerwms.call(this,i)):i instanceof L.TileLayer?e.push(this._encoders.layers.tilelayer.call(this,i)):i instanceof L.ImageOverlay?e.push(this._encoders.layers.image.call(this,i)):(i instanceof L.Marker||i instanceof L.Path&&i.toGeoJSON)&&n.push(i);return n.length&&e.push(this._encoders.layers.vector.call(this,n)),e},_encoders:{layers:{httprequest:function(t){var i=t._url;return-1!==i.indexOf("{s}")&&(i=i.replace("{s}",t.options.subdomains[0])),i=this._getAbsoluteUrl(i),{baseURL:i,opacity:t.options.opacity}},tilelayer:function(t){var i,o=this._encoders.layers.httprequest.call(this,t),e=t._url.substring(0,t._url.indexOf("{z}")),n=[];for(-1!==e.indexOf("{s}")&&(e=e.replace("{s}",t.options.subdomains[0])),i=0;i<=t.options.maxZoom;++i)n.push(L.print.Provider.MAX_RESOLUTION/Math.pow(2,i));return L.extend(o,{type:"OSM",baseURL:e,extension:"png",tileSize:[t.options.tileSize,t.options.tileSize],maxExtent:L.print.Provider.MAX_EXTENT,resolutions:n,singleTile:!1})},tilelayerwms:function(t){var i,o=this._encoders.layers.httprequest.call(this,t),e=t.options;L.extend(o,{type:"WMS",layers:[e.layers].join(",").split(","),format:e.format,styles:[e.styles].join(",").split(","),singleTile:!0});for(i in t.wmsParams)t.wmsParams.hasOwnProperty(i)&&-1==="detectretina,format,height,layers,request,service,srs,styles,version,width".indexOf(i.toLowerCase())&&(o.customParams||(o.customParams={}),o.customParams[i]=t.wmsParams[i]);return o},image:function(t){return{type:"Image",opacity:t.options.opacity,name:"image",baseURL:this._getAbsoluteUrl(t._url),extent:this._projectBounds(L.print.Provider.SRS,t._bounds)}},vector:function(t){var i,o,e,n,s,r,a,l,c=[],p={},h={},u={},d=1;for(a=0,l=t.length;l>a;a++){if(o=t[a],o instanceof L.Marker){var f=o.options.icon,_=f.options.iconUrl||L.Icon.Default.imagePath+"/marker-icon.png",y=L.Util.isArray(f.options.iconSize)?new L.Point(f.options.iconSize[0],f.options.iconSize[1]):f.options.iconSize,m=L.Util.isArray(f.options.iconAnchor)?new L.Point(f.options.iconAnchor[0],f.options.iconAnchor[1]):f.options.iconAnchor,v=this.options.dpi/L.print.Provider.DPI;e={externalGraphic:this._getAbsoluteUrl(_),graphicWidth:y.x/v,graphicHeight:y.y/v,graphicXOffset:-m.x/v,graphicYOffset:-m.y/v}}else e=this._extractFeatureStyle(o);n=JSON.stringify(e),h=u[n],h?s=h:(u[n]=s=d++,p[s]=e),r=o instanceof L.Circle?this._circleGeoJSON(o):o.toGeoJSON(),r.geometry.coordinates=this._projectCoords(L.print.Provider.SRS,r.geometry.coordinates),r.properties._leaflet_style=s,null===i&&(i=o.options.opacity||1),c.push(r)}return{type:"Vector",styles:p,opacity:i,styleProperty:"_leaflet_style",geoJson:{type:"FeatureCollection",features:c}}}}},_circleGeoJSON:function(t){var i,o=t._map.options.crs.projection,e=1;o===L.Projection.SphericalMercator?e=6378137:o===L.Projection.Mercator&&(e=o.R_MAJOR);var n=o.project(t.getLatLng()),s=1/Math.cos(t.getLatLng().lat*Math.PI/180),r=[];for(i=0;64>i;i++){var a=2*i*Math.PI/64,l=L.point(Math.cos(a),Math.sin(a));r.push(o.unproject(n.add(l.multiplyBy(t.getRadius()*s/e))))}return L.polygon(r).toGeoJSON()},_extractFeatureStyle:function(t){var i=t.options;return{stroke:i.stroke,strokeColor:i.color,strokeWidth:i.weight,strokeOpacity:i.opacity,strokeLinecap:"round",fill:i.fill,fillColor:i.fillColor||i.color,fillOpacity:i.fillOpacity}},_getAbsoluteUrl:function(t){var o;return L.Browser.ie?(o=i.createElement("a"),o.style.display="none",i.body.appendChild(o),o.href=t,i.body.removeChild(o)):(o=i.createElement("a"),o.href=t),o.href},_projectBounds:function(t,i){var o=i.getSouthWest(),e=i.getNorthEast();return this._projectCoords(t,o).concat(this._projectCoords(t,e))},_projectCoords:function(t,i){var o=t.toUpperCase().replace(":",""),e=L.CRS[o];if(!e)throw"Unsupported coordinate reference system: "+t;return this._project(e,i)},_project:function(t,i){var o,e,n,s;if("number"==typeof i[0]&&(i=new L.LatLng(i[1],i[0])),i instanceof L.LatLng)return e=t.project(i),[e.x,e.y];for(o=[],n=0,s=i.length;s>n;n++)o.push(this._project(t,i[n]));return o},onCapabilitiesLoad:function(t){this._capabilities=t,this.options.layout||(this.options.layout=this._capabilities.layouts[0].name),this.options.dpi||(this.options.dpi=this._capabilities.dpis[0].value),this.fire("capabilitiesload",{provider:this,capabilities:this._capabilities})},onPrintSuccess:function(i){var o=i.getURL+(L.Browser.ie?"?inline=true":"");this.options.autoOpen&&(L.Browser.ie?t.open(o):t.location.href=o),this._xhr=null,this.fire("print",{provider:this,response:i})},onPrintError:function(t){this._xhr=null,this.fire("printexception",{provider:this,response:t})}}),L.print.provider=function(t){return new L.print.Provider(t)},L.Control.Print=L.Control.extend({options:{position:"topleft",showLayouts:!0},initialize:function(t){L.Control.prototype.initialize.call(this,t),this._actionButtons={},this._actionsVisible=!1,this._provider=this.options.provider&&this.options.provider instanceof L.print.Provider?this.options.provider:L.print.Provider(this.options.provider||{})},onAdd:function(t){var i,o,e=L.DomUtil.create("div","leaflet-control-print"),n=L.DomUtil.create("div","leaflet-bar",e);return this._toolbarContainer=n,o=L.DomUtil.create("a","leaflet-print-print",n),o.href="#",o.title="Print map",L.DomEvent.on(o,"click",L.DomEvent.stopPropagation).on(o,"mousedown",L.DomEvent.stopPropagation).on(o,"dblclick",L.DomEvent.stopPropagation).on(o,"click",L.DomEvent.preventDefault).on(o,"click",this.onPrint,this),this.options.showLayouts&&(i=this._provider.getCapabilities(),i?this._createActions(e,i):this._provider.once("capabilitiesload",this.onCapabilitiesLoad,this)),this._provider.setMap(t),e},onRemove:function(){var t,i;for(t in this._actionButtons)this._actionButtons.hasOwnProperty(t)&&(i=this._actionButtons[t],this._disposeButton(i.button,i.callback,i.scope));this._actionButtons={},this._actionsContainer=null},getProvider:function(){return this._provider},_createActions:function(t,i){var o,e,n,s=i.layouts,r=s.length,a=L.DomUtil.create("ul","leaflet-print-actions",t),l=100,c=r*l+(r-1);for(a.style.width=c+"px",n=0;r>n;n++)e=L.DomUtil.create("li","",a),o=this._createButton({title:"Print map using the "+s[n].name+" layout",text:this._ellipsis(s[n].name,16),container:e,callback:this.onActionClick,context:this}),this._actionButtons[L.stamp(o)]={name:s[n].name,button:o,callback:this.onActionClick,context:this};this._actionsContainer=a},_createButton:function(t){var i=L.DomUtil.create("a",t.className||"",t.container);return i.href="#",t.text&&(i.innerHTML=t.text),t.title&&(i.title=t.title),L.DomEvent.on(i,"click",L.DomEvent.stopPropagation).on(i,"mousedown",L.DomEvent.stopPropagation).on(i,"dblclick",L.DomEvent.stopPropagation).on(i,"click",L.DomEvent.preventDefault).on(i,"click",t.callback,t.context),i},_showActionsToolbar:function(){L.DomUtil.addClass(this._toolbarContainer,"leaflet-print-actions-visible"),this._actionsContainer.style.display="block",this._actionsVisible=!0},_hideActionsToolbar:function(){this._actionsContainer.style.display="none",L.DomUtil.removeClass(this._toolbarContainer,"leaflet-print-actions-visible"),this._actionsVisible=!1},_ellipsis:function(t,i){return t&&t.length>i&&(t=t.substr(0,i-3)+"..."),t},onCapabilitiesLoad:function(t){this._createActions(this._container,t.capabilities)},onActionClick:function(t){var i,o,e=""+L.stamp(t.target);for(o in this._actionButtons)if(this._actionButtons.hasOwnProperty(o)&&o===e){i=this._actionButtons[o],this._provider.print({layout:i.name});break}this._hideActionsToolbar()},onPrint:function(){this.options.showLayouts?this._actionsVisible?this._hideActionsToolbar():this._showActionsToolbar():this._provider.print()}}),L.control.print=function(t){return new L.Control.Print(t)}}(this,document);